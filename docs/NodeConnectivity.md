# Node Connectivity

Each node exposes two web servers. One /api/v1/internal (for internode connectivity)
and another /api/v1/ (for end user access), on two separate ports.

The public endpoint uses operator-provided ssl certificates bound to the server domain.

The internal endpoint uses SSL certificates automatically generated and signed using the
global CA on the controller server.
The CA truststore is to be distributed by the operator to each node, and is used by them to
verify the security of the internal ssl connections.
The controller automatically distributes the SSL certificates to the nodes.
(Via the nodes fetching them from the controller)

Furthermore, to ensure that the internal requests are secure,
a JWT identity token is to be provided with each one.
The tokens are generated by the controller using the renewal token (see NodeCreation.md),
and subsequently stored on the node. The node should periodically refresh the token.

The controller validates requests going from the node to the controller, using its signing certificate.
The controller also validates requests between nodes in the following fashion:

1. Node A sends a request to Node B, using its token
2. Node B receives said token and validates it using the controller.
    - If Valid, it caches the token for its validity returned by the controller, and authorizes the request
    - If not, the request is not authorized.

Requests going from the controller to the node use the node's own access token, so that the node can validate
the request by comparing the token.

# Certificate auto-generation

The Controller possesses the CA private key and the CA root certificate.
The root certificate is to be distributed by the operator to all nodes.

The generation process begins with a node generating its own private key.
Then, using the private key, it generates a certificate signing request, and sends it to the controller along with its
refresh token.
The controller, using the signing request and its CA private key, the controller creates a certificate
(effectively, public key) and returns it to the node.
The node now possesses its private key, and its signed public key.